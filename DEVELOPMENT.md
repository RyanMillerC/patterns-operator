# Validated Patterns Operator Development

**Here be dragons üê≤**

Validated Patterns Operator is a Go-based Kubernetes operator built with the
[Operator Framework: Operator SDK].

Additionally, Validated Patterns Operator includes an React JS
[OpenShift Console Dynamic Plugin]. The code for the console plugin is under
*./console*.

This document describes how to:

* Requirements for development
* Settings up a development environment
* TODO: Others here

## Requirements for development

For operator development, you will need:

* MacOS or Linux workstation
* Podman (Preferred) or Docker
* Operator SDK CLI
* Go
* GNU Make
* OpenShift (Preferred) or OKD 4.10+ (Single-node works great!)
* A Quay.io account (Or push access to another container registry)

For console plugin (React JS) development, you will also need:

* NPM
* yarn

## Setting up a development environment

* Pattern - A single Git repo containing configuration-as-code to deploy a set of applications across OpenShift clusters.
* Pattern Catalog Definition (File) - A YAML file in a Git repo that contains a inventory of an organization's patterns.
* PatternCatalogSource - A Kubernetes object that points to a Pattern Catalog YAML file.
* PatternManifest - A Kubernetes object containing metadata about a single Pattern. These are generated by a PatternCatalogSource.
* Pattern Catalog Plugin - OpenShift Console plugin to view and install patterns. This UI is populated with data from PatternManifests.

## Testing your changes - Go/Operator

There are two ways to run the operator against a cluster for testing.

* Run the operator controller on your local workstation against a remote
  OpenShift cluster
* Run the operator controller directly on an OpenShift

### Test your changes locally against a remote cluster

Run the operator on your machine from your local directory against a cluster's
API.

```bash
# Log in to OpenShift
oc login

# Install CRDs, roles, etc.
make install

# Run on Linux amd64
make run

# Alternative to run on MacOS arm64 (M series)
GOOS=darwin GOARCH=arm64 make run
```

#### Test your changes on a cluster (Maintainers only)

Run the operator in a Pod on an OpenShift cluster. This will create a container
image under the *hybridcloudpatterns* organization in Quay.

**NOTE:** This method only works for maintainers who have push access to the
GitHub repository. To test changes in a forked repo, see *Test your changes on
a cluster (Anyone)* below.

```bash
BRANCH=`whoami`
git co -b $BRANCH
vi somefile.go
git commit
git push --set-upstream origin $BRANCH
# Wait for quay to build
VERSION=$BRANCH make deploy
```

#### Test your changes on a cluster (Anyone)

**NOTE:** When you are developing the operator, it will not show up under
*Installed Operators* because it is not managed by Operator Lifecycle Manager.

TODO: Fix this conflict when it's time to write docs
<<<<<<< HEAD
Create a `.env` file with your Quay username and version:

```bash
export USER=replace-me
export VERSION=0.0.12
export CHANNELS=fast

export IMAGE_TAG_BASE=quay.io/$USER/patterns-operator
export IMG=${IMAGE_TAG_BASE}:${VERSION}
```

Then, source that file before running make:

```
source .env
=======
Run the operator in a Pod on an OpenShift cluster. This will create a container
image under your user account in Quay.

**NOTE:** If you're doing this for the first time, the repo in Quay will be set
to private. You will need to change the permission on the repo to public before
running `make deploy`.

Replace $USER and the version of the operator.

```bash
vi somefile.go
export IMAGE_TAG_BASE=quay.io/$USER/patterns-operator
export IMG=quay.io/$USER/patterns-operator:0.0.2
>>>>>>> main
make docker-build docker-push bundle
make deploy
```

Restart the container to pick up the latest image from quay

```bash
oc delete pods -n patterns-operator-system --all; oc get pods -n patterns-operator-system -w
```

## Testing your changes - React JS/Console Plugin

test

### Validating end-to-end installation and upgrade path with OLM

The patterns operator is distributed through OLM from the official
[Community Operators](https://github.com/redhat-openshift-ecosystem/community-operators-prod)
catalog. It is a good idea to end-to-end validate OLM bundle changes before
releasing a new version.

This process will create an operator bundle that can be installed through OLM to
validate that the operator is working as expected for an end user.

Commit all of your working changes before running these commands. The make
targets will modify the *bundle* and *config* directories with references to
your username and version.

**It's easiest to commit your changes, run through the test, then clean up your
local directory with `git reset --hard && git clean -df`.**

Assuming the previous version was `0.0.1`, and we're not deploying to the
official Quay repository, start by defining the version, creating the 3 images,
and pushing them to quay:

The commands below will generate four container images:

* Operator bundle
* Controller
* Console
* OLM Catalog (For testing)

The OLM catalog is only necessary to install the candidate operator on a cluster.
The production operator uses the Community catalog so this image is not
necessary for actual releases.

**NOTE:** If you're doing this for the first time, when you push to Quay, the
container image repos will be set to private. You will need to change the
permission on the repos to make them public before running
`make catalog-install`.

Assuming the previous version was `0.0.1`, start by defining the version,
creating the 3 images, and pushing them to quay:

```
export USER=replace-me  # Replace user
export VERSION=0.0.2    # Replace version
export IMAGE_TAG_BASE=quay.io/$USER/patterns-operator
export CHANNELS=fast
make docker-build docker-push console-build console-push bundle bundle-build bundle-push catalog-build catalog-push
```

**NOTE:** If you run into errors with the `opm` command, upgrade your installed
opm version. opm release [1.26.5](https://github.com/operator-framework/operator-registry/releases/tag/v1.26.5)
or newer should be good.

Now create the CatalogSource on your cluster:

```
make catalog-install
```

After ~60 seconds, the CatalogSource object should have the status *READY*. (It
may briefly show the status *TRANSIENT_FAILURE* before showing *READY*.)

In the OpenShift Console, navigate to OperarorHub. Search for *Patterns
Operator*. Install the operator from the source *Test Patterns Operator*.

### Common Pitfalls

#### Console plugin doesn't load (Says 'Pending' on Overview page)

If you are having issues with the console plugin not appearing, clear your
website data (cache, cookies, etc.) and reload. I'm not sure why this happens.
I think it's an OpenShift Console thing, not an us thing.

### Releases

As a first step, make sure you have already cloned the community-operators-prod via `git clone git@github.com:$USER/community-operators-prod.git`
and that it is up-to-date:
```
# First make sure community-operators-prod is uptodate
cd community-operators-prod
git fetch --all; git checkout main; git pull
```

Then switch to the `patterns-operator` git folder, define the version and create the operator image:

```
cd ../patterns-operator
export VERSION=0.0.5
git checkout -b "patterns-operator-v$VERSION"
CHANNELS=fast make bundle
git commit -a -m "Upgrade version to ${VERSION}"
gh pr create
# Merge the PR
git checkout main
git pull
git tag $VERSION
git push <upstream-remote> $VERSION
# At this point make sure quay.io rebuilt the image with the right tag:
# https://quay.io/repository/hybridcloudpatterns/patterns-operator?tab=tags
# If the image did not get built (because the trigger got disabled), all the CI
# jobs for the community-operators-prod PR will fail

# Sync the bundle/ folder to the community-operators-prod git repo
rsync -va bundle/ ../community-operators-prod/operators/patterns-operator/$VERSION
```

Next, create the OperatorHub release, by creating the community operator PR:

```
cd ../community-operators-prod
git checkout -b "patterns-operator-v$VERSION"
git add operators/patterns-operator/$VERSION/
git commit -s -m "operator patterns-operator ($VERSION)"
git push <fork-remote> "patterns-operator-v$VERSION"

# Inspect the diff from the previously released version
cd operators/patterns-operator
diff -urN $(ls -1rv | grep -v ci.yaml | head -n2 | sort)

# Now create a PR against https://github.com/redhat-openshift-ecosystem/community-operators-prod
# Use the web interface so you can fill in the web template
# Create the PR and make sure you flag the questions under `Updated to existing Operators`
# and section `Your submission should not`
# Example PR https://github.com/redhat-openshift-ecosystem/community-operators-prod/pull/1569
# The PR will get automatically merged once CI passes and the PR is pushed by one of the OWNERS of the patterns-operator
# subfolder inside community-operators-prod
```

References:

- https://sdk.operatorframework.io/docs/building-operators/golang/quickstart/

Follow https://sdk.operatorframework.io/docs/installation/ to install the operator-sdk

[Operator Framework: Operator SDK]: https://sdk.operatorframework.io/
